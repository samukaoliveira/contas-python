{% load static %}
{% load humanize %}


<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Finanças</title>

    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    
    <link rel="stylesheet" href="{% static 'contas/app.css' %}">
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header">
    <!-- BOTÃO MENU -->
    <button class="menu-btn" onclick="toggleMenu()" aria-label="Menu">
        <i class="fa-solid fa-bars"></i>
    </button>

    <!-- MENU LATERAL -->
    {% include "contas/shared/_menu.html" %}

    <!-- COMPETÊNCIA -->
    {% include "contas/shared/_competencia.html" %}

    <!-- AÇÕES -->
    <div class="login">
        <button class="logout-btn">
            ⎋ Sair
        </button>
    </div>
</div>

<!-- AÇÕES -->
 <div class="novo">
    <button class="add-lancamento-btn" onclick="openModal()">
        <i class="fa-solid fa-circle-plus"></i> Novo Lançamento
    </button>
</div>

<!-- ===== RESUMO ===== -->
<div class="cards">

    <div class="card saldo">
        <h3><i class="fa-solid fa-sack-dollar"></i> Saldo em Caixa</h3>
        {% if saldo_em_caixa < 0 %}
            <p class="despesa">R$ {{ saldo_em_caixa }}</p>
        {% else %}
            <p class="receita">R$ {{ saldo_em_caixa }}</p>
        {% endif %}
    </div>

    <div class="card">
        <h3><i class="fa-solid fa-arrow-trend-up"></i> Receitas previstas</h3>
        <p class="receita">R$ {{ receitas_previstas }}</p>
    </div>

    <div class="card">
        <h3><i class="fa-solid fa-arrow-trend-down"></i> Despesas previstas</h3>
        <p class="despesa">R$ {{ despesas_previstas }}</p>
    </div>

    <div class="card">
        <h3><i class="fa-solid fa-circle-check"></i> Receitas realizadas</h3>
        <p class="receita">R$ {{ receitas_realizadas }}</p>
    </div>

    <div class="card">
        <h3><i class="fa-solid fa-circle-xmark"></i> Despesas realizadas</h3>
        <p class="despesa">R$ {{ despesas_realizadas }}</p>
    </div>
</div>

<!-- ===== TABELA ===== -->
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Data</th>
                <th>Lançamento</th>
                <th>Valor</th>
                <th>Natureza</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
        {% for c in cartoes %}
            <tr>
                <td>{{ c.vencimento }}/{{ competencia.mes }}/{{ competencia.ano }}</td>
                <td>Cartão {{ c.descricao }}</td>
                <td class="valor"> {% if c.fatura < 0 %}
                                        <span class="despesa">R$ {{ c.fatura }}</span>
                                    {% else %}
                                        <span class="receita"></span>R$ {{ c.fatura }}</span>
                                    {% endif %}</td>
                <td>DESPESA</td>
                <td>
                </td>
                <td><span><button class="acao edit" onclick="openModalFatura()">
                        <i class="fa-solid fa-pen"></i>
                    </button></span>
            </tr>
        {% endfor %}
        {% for l in lancamentos %}
            <tr>
                <td>{{ l.data|date:"d/m/Y" }}</td>
                <td>{{ l.descricao }}</td>
                <td class="valor"> {% if l.natureza == "DESPESA" %}
                                        <span class="despesa">R$ -{{ l.valor|floatformat:2|intcomma }}</span>
                                    {% else %}
                                        <span class="receita"></span>R$ {{ l.valor|floatformat:2|intcomma }}</span>
                                    {% endif %}</td>
                <td>{{ l.natureza }}</td>
                <td>
                    {% if l.pago %}
                        <span class="pago">
                            <i class="fa-solid fa-check"></i> Pago
                        </span>
                    {% else %}
                        <span class="nao-pago">
                            <i class="fa-solid fa-clock"></i> Pendente
                        </span>
                    {% endif %}
                </td>
                <td><span><button class="acao edit" onclick="openEditModal(
                        '{{ l.id }}',
                        '{{ l.data|escapejs }}',
                        '{{ l.descricao }}',
                        '{{ l.valor }}',
                        '{{ l.natureza }}',
                        '{{ l.pago }}')">
                        <i class="fa-solid fa-pen"></i>
                    </button></span>
                    <span>
                        <a href="{% url 'lancamentos_delete_path' l.id %}">
                            <button class="acao delete">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </a>
                    </span>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

{% include "contas/shared/_modal_lancamentos.html" %}
{% include "contas/shared/_modal_pagar_fatura.html" %}

<script>
    function openModal() {
        document.getElementById('modalLancamento').style.display = 'flex';
    }

    function closeModal() {
        const form = document.querySelector("#modalLancamento form");
        form.reset();
        document.getElementById('modalLancamento').style.display = 'none';
    }

    function toggleMenu() {
        document.getElementById('navLinks').classList.toggle('aberto');
    }

    function openEditModal(id, data, descricao, valor, natureza, pago) {
    const form = document.querySelector('#modalLancamento form');

    form.action = `/update/${id}/`;

    form.data.value = data;
    form.descricao.value = descricao;
    form.valor.value = parseFloat(valor.replace(',', '.'));
    form.natureza.value = natureza;
    form.pago.checked = pago === 'True' || pago === true;



    document.querySelector('#modalLancamento h2').innerText = 'Editar Lançamento';

    openModal();
}

     function openModalFatura() {
        document.getElementById('modalPagarFatura').style.display = 'flex';
    }

     function closeModalFatura() {
         const form = document.querySelector("#modalPagarFatura form");
         form.reset();
         document.getElementById('modalPagarFatura').style.display = 'none';
    }

</script>

</body>
</html>
